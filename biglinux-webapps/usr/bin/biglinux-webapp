#!/usr/bin/env bash

detect_browser() {
    if [ $1 ]; then
        return
    fi

    browser_bin_list=( "brave" "brave-browser" "google-chrome-stable" "vivaldi-stable" "vivaldi-snapshot" "microsoft-edge-beta" "microsoft-edge-dev" "microsoft-edge-stable" "yandex-browser-stable" "yandex-browser-beta" "flashpeak-slimjet" "electron" )
    # waiting for opera devs to add support for webapps

    local def=""
    for browser in "${browser_bin_list[@]}"; do
        if [ -x /usr/bin/"$browser" ]; then
            def="$browser"
            return
        elif [ "$browser" = "electron" ]; then
            # loop from 10 to 20
            for i in {20..10}; do
                if [ -x /usr/bin/electron"$i" ]; then
                    1="electron$i"
                    return
                fi
            done
        fi
    done

    [ "$def" ] || def="chromium"

    echo "$def" > $HOME/.bigwebapps/BROWSER
}

detect_lang() {
    local cpdflang="" clc="" nfxlang="" nlc=""
    case "${LANG:0:2}" in
        "pt")
            cpdflang="/pt"
            clc="__pt"
            nfxlang="/br"
            nlc="__br"
            ;;
        "es")
            cpdflang="/es"
            clc="__es"
            ;;
        *) ;;
    esac
}

parse_args() {
    if [[ "$@" = *"--app="* ]]; then
        return
    fi

    local newargs="" appname="" profile=""

    local url="" path="" langclass="" langpath=""
    for a in ${args[@]};do
        if [[ "$a" != "--"* ]];then
            if [[ "$a" == *"://"* ]]; then
                unp="${a#*://}"
                url="${unp%%/*}"
                path="/${unp#*/}"
                [ "$path" == "/$url" ] && path=""
            else
                    [[ "$a" == *"."* ]] && ping -c 1 -w 1 "$a" && url="$a" ||appname="$a"
            fi
        elif [[ "$a" != "--class"* ]]; then
            newargs="$newargs $a"
            [[ "$a" == "--profile"* ]] && profile=y
        fi
    done

    [ "$profile" ] || newargs="$newargs --profile-directory=Default"

    [ "$appname" ] && case "$appname" in
        # this needs to be sorted by popularity, but i'm so lazy :)
        *"cleverpdf"*)
            url="www.cleverpdf.com"
            langclass="$clc"
            langpath="$cpdflang"
            ;;
        *"netflix"*)
            url="www.netflix.com"
            langclass="$nlc"
            langpath="$nfxlang"
            ;;
        *"youtube-music"*)
            url="music.youtube.com"
            ;;
        *"youtube"*)
            url="www.youtube.com"
            ;;
        *"twitch"*)
            url="www.twitch.tv"
            ;;
        *"facebook"*)
            url="www.facebook.com"
            ;;
        *"twitter"*)
            url="www.twitter.com"
            ;;
        *"instagram"*)
            url="www.instagram.com"
            ;;
        *"reddit"*)
            url="www.reddit.com"
            ;;
        *"pinterest"*)
            url="www.pinterest.com"
            ;;
        *"linkedin"*)
            url="www.linkedin.com"
            ;;
        *"messenger"*)
            url="www.messenger.com"
            ;;
        *"whatsapp"*)
            url="web.whatsapp.com"
            ;;
        *"odysee"*)
            url="www.odysee.com"
            ;;
        *"spotify"*)
            url="www.spotify.com"
            ;;
        *"msoffice"*)
            url="www.office.com"
            ;;
        *"outlook"*)
            url="www.outlook.com"
            ;;
        *"onedrive"*)
            url="www.onedrive.com"
            ;;
        *"discord"*)
            url="discord.com"
            path="/app"
            ;;
        *"msteams"*)
            url="teams.microsoft.com"
            ;;
        *"skype"*)
            url="web.skype.com"
            ;;
        *"telegram"*)
            url="web.telegram.com"
            ;;
        *"slack"*)
            url="www.slack.com"
            ;;
        *"deezer"*)
            url="www.deezer.com"
            ;;
        *"gmail"*)
            url="mail.google.com"
            ;;
        *"gclassroom"*)
            url="classroom.google.com"
            ;;
        *"gsheets"*)
            url="docs.google.com"
            path="/spreadsheets"
            ;;
        *"gdocs"*)
            url="docs.google.com"
            ;;
        *"gdrive"*)
            url="drive.google.com"
            ;;
        *"gcalendar"*)
            url="calendar.google.com"
            ;;
        *"gcontacts"*)
            url="contacts.google.com"
            ;;
        *"gphotos"*)
            url="photos.google.com"
            ;;
        *"hangouts"*)
            url="hangouts.google.com"
            ;;
        *"gkeep"*)
            url="keep.google.com"
            ;;
        *"gmaps"*)
            url="maps.google.com"
            ;;
        *"gmeet"*)
            url="meet.google.com"
            ;;
        *"gslides"*)
            url="docs.google.com"
            path="/presentation"
            ;;
        *"gtrans"*)
            url="translate.google.com"
            ;;
        *"ymail"*)
            url="mail.yahoo.com"
            ;;
        *) ;;
    esac

    if [ "$url" ]; then
        newargs="$newargs --class=\"${url}${langclass},Chromium-browser\""
    else
        echo "ERROR: No URL/Application specified, launching new instance..."
        url="chrome://newtab"
    fi

    args="$newargs --app=https://${url}${langpath}${path}"
}

BROWSER="$(<$HOME/.bigwebapps/BROWSER)"
detect_browser "$BROWSER"

detect_lang

args="$@"
parse_args $@

exec "$BROWSER" $args
